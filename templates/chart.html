<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biểu đồ phát hiện người</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #eef2f3;
        }
        .chart-container {
            max-width: 800px;
            margin: auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2em;
            letter-spacing: 1px;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        select, input {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: calc(50% - 20px);
            box-sizing: border-box;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        .center {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .video-container {
            margin-top: 30px;
            text-align: center;
        }
        video {
            max-width: 100%;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h1>Phát hiện người theo khoảng thời gian</h1>

        <div class="center">
            <select id="timeRange" onchange="updateChart()">
                <option value="day">Ngày</option>
                <option value="month">Tháng</option>
            </select>

            <select id="chartType" onchange="updateChart()">
                <option value="bar">Biểu đồ cột</option>
                <option value="line">Biểu đồ đường</option>
                <option value="pie">Biểu đồ tròn</option>
            </select>
        </div>

        <div class="center">
            <input type="date" id="dateInput" onchange="updateChart()" />
            <input type="month" id="monthInput" onchange="updateChart()" style="display: none;" />
        </div>

        <canvas id="myChart"></canvas>  
    </div>

    <div class="video-container">
        <h2>Xem Video Phát Hiện Người</h2>
        <video id="videoPlayer" controls>
            <source id="videoSource" src="" type="video/mp4">
            Trình duyệt của bạn không hỗ trợ video.
        </video>
        <br>
        <select id="videoSelect" onchange="updateVideo()"></select>
    </div>

    <script>
        let myChart; // Biến để lưu đối tượng biểu đồ

        // Cập nhật biểu đồ dựa trên lựa chọn của người dùng
        function updateChart() {
            const timeRange = document.getElementById('timeRange').value;
            const chartType = document.getElementById('chartType').value;
            let apiUrl = '/get_chart_data?range=' + timeRange;

            if (timeRange === 'day') {
                const selectedDate = document.getElementById('dateInput').value || getCurrentDate();
                apiUrl += '&date=' + selectedDate;
                document.getElementById('dateInput').style.display = 'block';
                document.getElementById('monthInput').style.display = 'none';
            } else if (timeRange === 'month') {
                const selectedMonth = document.getElementById('monthInput').value || getCurrentMonth();
                apiUrl += '&month=' + selectedMonth;
                document.getElementById('dateInput').style.display = 'none';
                document.getElementById('monthInput').style.display = 'block';
            }

            fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const labels = ['Sáng', 'Trưa', 'Chiều', 'Tối'];
                const chartData = [data.Sáng || 0, data.Trưa || 0, data.Chiều || 0, data.Tối || 0];

                if (myChart) {
                    myChart.destroy();
                }

                const ctx = document.getElementById('myChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Số người phát hiện',
                            data: chartData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        }

        // Lấy ngày hiện tại ở định dạng YYYY-MM-DD
        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Lấy tháng hiện tại ở định dạng YYYY-MM
        function getCurrentMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        // Cập nhật video khi người dùng chọn video mới
        function updateVideo() {
            const videoSelect = document.getElementById('videoSelect');
            const videoPlayer = document.getElementById('videoPlayer');
            const selectedVideo = videoSelect.value;

            // Cập nhật đường dẫn video
            videoPlayer.src = selectedVideo;
            videoPlayer.load();
            videoPlayer.play();
        }

        // Tải danh sách video và thêm vào dropdown
        function loadVideos() {
            fetch('/get_video_paths')
            .then(response => response.json())
            .then(videoPaths => {
                const videoSelect = document.getElementById('videoSelect');
                videoSelect.innerHTML = '';

                // Thêm từng video vào dropdown
                videoPaths.forEach(videoPath => {
                    const option = document.createElement('option');
                    option.value = videoPath;
                    option.textContent = videoPath;
                    videoSelect.appendChild(option);
                });

                // Chọn video đầu tiên
                if (videoPaths.length > 0) {
                    videoSelect.value = videoPaths[0];
                    updateVideo(); // Tự động phát video đầu tiên
                }
            });
        }

        // Khởi tạo ngày/tháng hiện tại và tải danh sách video khi trang được tải
        window.onload = function() {
            const dateInput = document.getElementById('dateInput'); // Lấy trường nhập ngày
            const monthInput = document.getElementById('monthInput'); // Lấy trường nhập tháng
            dateInput.value = getCurrentDate(); // Gán giá trị ngày hiện tại
            monthInput.value = getCurrentMonth(); // Gán giá trị tháng hiện tại
            loadVideos(); // Tải danh sách video
            updateChart(); // Cập nhật biểu đồ khi tải trang
        };
    </script>
</body>
</html>
